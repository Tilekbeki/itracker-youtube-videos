---
created at: 2025-08-19
tags:
  - review
zero-links:
  - 03.02 WEB API
sr-due: 2025-09-23
sr-interval: 1
sr-ease: 230
---
**HTTP Cookie** - это небольшой фрагмент данных отправляемых сервером на браузер пользователя, который тот может сохранить и отсылать обратно с новым запросом к данному серверу.

При обращении к серверу он возвращает куки, которые потом при каждом запросе на сервер передаются вместе с запросом, так сервер может идентифицировать пользователя и например не запрашивать авторизацию повторно.

**Используются для:**

- Управление сеансом (логины, токены)
- Мониторинга, отслеживания поведения пользователя
- Персонализации (пользовательские предпочтения)

`document.cookie` предоставляет доступ к куки.

- Операция записи изменяет только то куки, которое было указано.
- Имя и значение куки должны быть закодированы.
- Одно куки вмещает до 4kb данных, разрешается не менее 20 куки на сайт (зависит от браузера) и не менее 300 в общем, если они помещаются в выделенные 4 килобайта.

**Настройки куки:**

- `path=/`, по умолчанию устанавливается текущий путь, делает куки видимым только по указанному пути и ниже.
- `domain=site.com`, по умолчанию куки видно только на текущем домене, если явно указан домен, то куки видно и на поддоменах.
- `expires` или `max-age` устанавливает дату истечения срока действия, без них куки умрёт при закрытии браузера.
- `secure` делает куки доступным только при использовании HTTPS.
- `samesite` запрещает браузеру отправлять куки с запросами, поступающими из других доменов, помогает предотвратить XSRF-атаки.

Дополнительно:

Сторонние куки могут быть запрещены браузером, например Safari делает это по умолчанию.

Установка отслеживающих куки пользователям из стран ЕС требует их явного согласия на это в соответствии с законодательством GDPR.

## [Чтение из document.cookie](https://learn.javascript.ru/cookie#chtenie-iz-document-cookie)

Хранит ли ваш браузер какие-то куки с этого сайта? Посмотрим:

// На javascript.info мы используем сервис Google Analytics для сбора статистики, // поэтому какие-то куки должны быть alert( document.cookie ); // cookie1=value1; cookie2=value2;...

​

Значение 

`document.cookie` состоит из пар `ключ=значение`, разделённых;

Каждая пара представляет собой отдельное куки.

Чтобы найти определённое куки, достаточно разбить строку из `document.cookie` по `;` , и затем найти нужный ключ. Для этого мы можем использовать как регулярные выражения, так и функции для обработки массивов.

## [Запись в document.cookie](https://learn.javascript.ru/cookie#zapis-v-document-cookie)

Мы можем писать в 

`document.cookie`. Но это не просто свойство данных, а [акcессор (геттер/сеттер)](https://learn.javascript.ru/property-accessors). Присваивание к нему обрабатывается особым образом.

Запись в `document.cookie` обновит только упомянутые в ней куки, но при этом не затронет все остальные.

Например, этот вызов установит куки с именем `user` и значением `John`:

```js
document.cookie = "user=John"; // обновляем только куки с именем 'user' alert(document.cookie); // показываем все куки
```

Если вы запустите этот код, то, скорее всего, увидите множество куки. Это происходит, потому что операция `document.cookie=` перезапишет не все куки, а лишь куки с вышеупомянутым именем `user`.

Технически, и имя и значение куки могут состоять из любых символов, для правильного форматирования следует использовать встроенную функцию `encodeURIComponent`:

```js
// специальные символы (пробелы), требуется кодирование
let name = "my name";
let value = "John Smith"

// кодирует в my%20name=John%20Smith
document.cookie = encodeURIComponent(name) + '=' + encodeURIComponent(value);

alert(document.cookie); // ...; my%20name=John%20Smith
```

При установке кук можно указывать не только её название и значение, но и другие параметры. Все они являются необязательными и разделяются точкой с запятой `;`

Эти настройки указываются после пары `ключ=значение` и отделены друг от друга разделителем `;`, вот так:
```js
document.cookie = "user=John; path=/; expires=Tue, 19 Jan 2038 03:14:07 GMT"
```

- `path` – определяет путь, по которому будет доступна кука. Он должен быть абсолютным, то есть начинаться с `/`. Если параметр не передан, то кука будет доступна на всех страницах сайта.
- `domain` - определяет домен, для которого указана кука. Если не указано, то будет использоваться текущий домен.
- `maxage` и `expires` - определяет время жизни куки.`maxage` указывает, через сколько секунд, а `expires` указывает точное время, когда кука станет недействительна. Время для `expires` можно отформатировать с помощью встроенного метода даты `Date.toUTCString()`
- `secure` - указывает, что данная кука может быть передана только при запросах по защищённому протоколу HTTPS.
- `samesite` - определяет, может ли данная кука быть отправлена при кросс-доменном запросе. Значение параметра `strict` будет предотвращать отправку на другие домены, а `lax` разрешит отправлять куки с GET-запросами.

Есть пара ограничений при специфичных названиях кук. Если название куки начинается с `__Secure`, то обязательно должен быть передан параметр `secure`. При этом мы должны находиться на странице, которая была получена по HTTPS-протоколу. Если название куки начинается с `__Host`, то обязательно должны быть переданы параметры `path=/` и `secure` (страница также должна быть открыта по HTTPS-протоколу), а атрибут `domain` должен отсутствовать для снижения кроссдоменных уязвимостей.

Запись куки с разрешением передавать её только по HTTPS и только для текущего домена, со временем жизни в 1 час будет выглядеть так:
```js
document.cookie = 'sidebar=true;secure;samesite=strict;max-age=3600'
```
![[Pasted image 20250919175505.png]]

Для установки куки, которая будет доступна на текущем домене и всех его поддоменах, используйте название текущего домена и поставьте точку в начале

```jsx
.${window.location.hostname}
```

**Cookie** — это просто пара имя-значение, которую (точнее, которые) сервер может оставить у клиента (браузера). Наглядно:

1. Приходит клиент, спрашивает у сервера страницу.
2. Сервер в заголовках ответе может установить cookies. Например, выдав два заголовка: `Set-Cookie: foo=123` и `Set-Cookie: bar=baz` — по-русски — «запомни, foo — 123, а bar — baz».
3. При следующем обращении клиент, если он решил запомнить, говорит серверу «Cookie: bar=baz; foo=123».

Упрощенно, не затрагивая тонкости — все, вот все, что представляют собой cookies.

**Сессии** — более эфемерное понятие, которое не привязано к какой-то конкретной реальной технологии. Это просто некая методика, которая позволяет отличить одного клиента от другого, и, как правило, где-то хранить связанные с каждым клиентом данные.

Как правило, сессии реализуются используя cookies и идентификаторы сессий. Т.е. сервер со своей стороны создает уникальный идентификатор, например, «1a2b3c» (**`session_id`** про который вы спрашивали), а клиента просит его запомнить. Обычно — при помощи cookies, говоря что-то в духе `Set-Cookie: PHPSESSID=1a2b3c` (где «`PHPSESSID`» — **имя сессии**, обычно, оно только одно, вести параллельно несколько сессий нужно редко). Со своей стороны сервер где-то (зависит от реализации, иногда это файл, например, `/tmp/1a2b3c`, иногда запись в БД, иногда еще что-то) хранит различные данные, которые ему приказано связывать с этой сессией. Например, имя пользователя.

**Еще** момент. Сами по себе сессии не дают авторизации — это только хранилище. Авторизацию делаете Вы сами (или фреймворк, которым Вы воспользовались). Вы пользуетесь тем, что данные, связанные с сессией (в типичной PHP'шной реализации) хранятся на сервере, и клиент их там подменить не может.

Соответственно, когда клиент аутентифицируется — в сессии сохраняется кто он. Обратно — если у нас в сессии записано кто он — можно этому верить. Вся дальнейшая логика — пускать ли клиента, давать ли ему какие-то возможности и т.д. — на Вас.

### `Secure` ("безопасные") и `HttpOnly` куки

"Безопасные" (secure) куки отсылаются на сервер только тогда, когда запрос отправляется по протоколу SSL и HTTPS. Однако важные данные никогда не следует передавать или хранить в куках, поскольку сам их механизм весьма уязвим в отношении безопасности, а флаг `secure` никакого дополнительного шифрования или средств защиты не обеспечивает. Начиная с Chrome 52 и Firefox 52, незащищённые сайты (http:) не могут создавать куки с флагом `Secure`.

Куки HTTPonly не доступны из JavaScript через свойства [`Document.cookie`](https://developer.mozilla.org/ru/docs/Web/API/Document/cookie) API, что помогает избежать межсайтового скриптинга ([XSS (en-US)](https://developer.mozilla.org/en-US/docs/Glossary/Cross-site_scripting)). Устанавливайте этот флаг для тех кук, к которым не требуется обращаться через JavaScript. В частности, если куки используются только для поддержки сеанса, то в JavaScript они не нужны, так что в этом случае следует устанавливать флаг `HttpOnly`.

```jsx
Set-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT; Secure; HttpOnly
```

Способы предотвращения атак, использующих куки:

- Используйте атрибут `HttpOnly` для предотвращения доступа к кукам из JavaScript.
- Куки, которые используются для хранения чувствительной информации, такой как аутентификационный токен, должны иметь короткое время жизни и атрибут `SameSite`, установленный в `Strict` или `Lax`. Для того чтобы узнать больше, смотрите раздел [SameSite](https://developer.mozilla.org/ru/docs/Web/HTTP/Cookies#%D0%BA%D1%83%D0%BA%D0%B8_samesite). В [браузерах с поддержкой SameSite](https://developer.mozilla.org/ru/docs/Web/HTTP/%D0%B1%D1%80%D0%B0%D1%83%D0%B7%D0%B5%D1%80%D0%B0%D1%85%20%D1%81%20%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%BE%D0%B9%20SameSite) это гарантирует предотвращение отправки кук аутентификации с межсайтовыми запросами, фактически такие запросы с точки зрения бэкенда становятся неаутентифицированными.

[https://proglib.io/p/veb-autentifikaciya-fayly-cookies-ili-tokeny-2021-08-14](https://proglib.io/p/veb-autentifikaciya-fayly-cookies-ili-tokeny-2021-08-14)
